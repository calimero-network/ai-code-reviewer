name: Documentation Bot

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'src/**'
      - 'config.example.yaml'
      - 'pyproject.toml'

permissions:
  contents: read
  pull-requests: write

jobs:
  doc-check:
    name: Check Documentation Sync
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        # Pinned to v4.1.7 - https://github.com/actions/checkout/releases/tag/v4.1.7
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332
        with:
          # Only need current commit and base for comparison
          fetch-depth: 2
      
      - name: Get changed files
        id: changed-files
        # Pinned to v44.5.2 - https://github.com/tj-actions/changed-files/releases/tag/v44.5.2
        uses: tj-actions/changed-files@d6babd6899969df1a11d14c368283ea4436bca78
        with:
          files: |
            src/**
            config.example.yaml
            pyproject.toml
      
      # Only install dependencies if files actually changed
      - name: Setup Python
        if: steps.changed-files.outputs.any_changed == 'true'
        # Pinned to v5.1.0 - https://github.com/actions/setup-python/releases/tag/v5.1.0
        uses: actions/setup-python@39cd14951b08e74b54015e9e001cdefcf80e669f
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          pip install -e ".[dev]"
      
      - name: Analyze documentation needs
        id: doc-analysis
        if: steps.changed-files.outputs.any_changed == 'true'
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Pass changed files via environment variable to prevent command injection
          CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
        run: |
          # Create secure temporary file with restricted permissions
          TMPFILE=$(mktemp)
          chmod 600 "$TMPFILE"
          echo "$CHANGED_FILES" > "$TMPFILE"
          
          # Run the doc-check analysis
          if [ -n "$CURSOR_API_KEY" ]; then
            python << 'PYTHON_EOF'
import os
import sys
from pathlib import Path

# Read changed files safely from environment
changed_files_str = os.environ.get('CHANGED_FILES', '')
changed = changed_files_str.split() if changed_files_str else []

# Analyze each changed file for documentation impact
suggestions = []

for filepath in changed:
    # Sanitize filepath - only allow expected characters
    if not all(c.isalnum() or c in '._-/' for c in filepath):
        print(f"Warning: Skipping file with unexpected characters: {filepath}", file=sys.stderr)
        continue
    
    path = Path(filepath)
    
    # Check if it's a Python file in a documented module
    if path.suffix == '.py' and path.parent.name in ['agents', 'orchestrator', 'github', 'models']:
        suggestions.append({
            'file': f'.ai/rules/{path.parent.name}.md',
            'reason': f'File `{filepath}` changed - may need documentation update',
            'priority': 'normal'
        })
    
    # Check if it changes config
    if 'config' in filepath.lower():
        suggestions.append({
            'file': 'config.example.yaml',
            'reason': 'Configuration changes may need example updates',
            'priority': 'normal'
        })
        suggestions.append({
            'file': 'README.md',
            'reason': 'Configuration changes may affect README docs',
            'priority': 'normal'
        })
    
    # Check if it's CLI changes
    if 'cli' in filepath.lower():
        suggestions.append({
            'file': 'README.md',
            'reason': 'CLI changes may need README command documentation update',
            'priority': 'normal'
        })

# Deduplicate suggestions by file
seen_files = set()
unique_suggestions = []
for s in suggestions:
    if s['file'] not in seen_files:
        seen_files.add(s['file'])
        unique_suggestions.append(s)

# Output suggestions using GitHub Actions output format
output_file = os.environ.get('GITHUB_OUTPUT', '/dev/stdout')
with open(output_file, 'a') as f:
    f.write('SUGGESTIONS<<EOF\n')
    if unique_suggestions:
        f.write('## ðŸ“š Documentation Check\n\n')
        f.write('The following documentation files may need updates based on code changes:\n\n')
        for s in unique_suggestions:
            f.write(f"- **{s['file']}**: {s['reason']} [{s['priority']}]\n")
        f.write('\n*Please review these suggestions and update documentation if needed.*\n')
    else:
        f.write('âœ… No documentation updates detected as needed.\n')
    f.write('EOF\n')
PYTHON_EOF
          else
            # Fallback when no API key - provide manual checklist
            echo "::notice::Documentation bot running in manual mode (no CURSOR_API_KEY configured)"
            {
              echo "SUGGESTIONS<<EOF"
              echo "## ðŸ“š Documentation Check (Manual Mode)"
              echo ""
              echo "âš ï¸ Automated analysis skipped (no API key configured)."
              echo ""
              echo "**Changed files to manually check for doc updates:**"
              echo ""
              # Read from temp file to avoid interpolation issues
              cat "$TMPFILE" | tr ' ' '\n' | while read -r file; do
                if [ -n "$file" ]; then
                  echo "- \`$file\`"
                fi
              done
              echo ""
              echo "*Please manually verify if documentation updates are needed.*"
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
          fi
          
          # Clean up temp file
          rm -f "$TMPFILE"
      
      - name: Post comment on PR
        if: steps.doc-analysis.outputs.SUGGESTIONS != ''
        # Pinned to v7.0.1 - https://github.com/actions/github-script/releases/tag/v7.0.1
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea
        env:
          # Pass suggestions via environment to avoid interpolation issues
          SUGGESTIONS: ${{ steps.doc-analysis.outputs.SUGGESTIONS }}
        with:
          script: |
            const suggestions = process.env.SUGGESTIONS;
            
            // Find existing bot comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(c => 
              c.user.type === 'Bot' && 
              c.body.includes('ðŸ“š Documentation')
            );
            
            const body = suggestions + '\n\n---\n<sub>ðŸ¤– Generated by Documentation Bot | [Configure](.ai/doc-bot.md)</sub>';
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
